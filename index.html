<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OkEmby å…¬ç›ŠåŠ é€Ÿè®¡åˆ’ - è´Ÿè½½ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ä¿æŒåŸæœ‰çš„å¼¹çª—æ ·å¼ä¸å˜ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #25262b; width: 90%; max-width: 800px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #373a40; animation: fadeIn 0.3s ease; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #fff; font-size: 1.5rem; }
        .btn-close { background: none; border: none; font-size: 2rem; color: #888; cursor: pointer; line-height: 1; transition: color 0.2s; }
        .btn-close:hover { color: #fff; }
        .proxy-url-box { background: #1a1b1e; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border: 1px solid #2c2e33; }
        .proxy-url-box code { color: #4caf50; font-family: monospace; font-size: 1.1rem; overflow-x: auto; margin-right: 10px; }
        .btn-copy { background: #228be6; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        .btn-copy:hover { background: #1c7ed6; }
        .btn-recommend { background: linear-gradient(45deg, #4caf50, #228be6); color: white; border: none; padding: 12px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); transition: transform 0.2s; }
        .btn-recommend:hover { transform: translateY(-2px); }
        tbody tr { cursor: pointer; transition: background 0.2s; }
        tbody tr:hover { background: #2c2e33; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        footer { text-align: center; padding: 30px 0; margin-top: 40px; color: #7a7a7a; font-size: 0.9rem; border-top: 1px solid #2c2e33; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container">
            <div class="logo">ğŸš€ OkEmby åŠ é€Ÿç›‘æ§</div>
            <a href="donate.html" class="btn-donate">â• æèµ èŠ‚ç‚¹ (åŠ å…¥å…±å»º)</a>
        </div>
    </nav>

    <div class="container main-content">
        <div class="card highlight-card" style="text-align: center; padding: 40px 20px;">
            <h2 style="margin-bottom: 10px;">âš¡ å¯»æ‰¾æœ€å¿«èŠ‚ç‚¹ï¼Ÿ</h2>
            <p style="color: #aaa; margin-bottom: 25px;">ç³»ç»Ÿä¼šæ ¹æ®å®æ—¶è´Ÿè½½ï¼Œä¸ºæ‚¨æ¨èå½“å‰æœ€ç©ºé—²ã€é€Ÿåº¦æœ€å¿«çš„åä»£èŠ‚ç‚¹ã€‚</p>
            <button onclick="recommendBestNode()" class="btn-recommend">ğŸ² ä¸€é”®è·å–ä»Šæ—¥æœ€ä½³èŠ‚ç‚¹</button>
            <p class="status-text" style="margin-top: 20px;">ğŸŸ¢ ç›‘æ§ç³»ç»ŸçŠ¶æ€ï¼š<span id="system-status">æ­£åœ¨åˆå§‹åŒ–...</span></p>
        </div>

        <h3>ğŸ“Š èŠ‚ç‚¹å®æ—¶çŠ¶æ€ (ç‚¹å‡»åˆ—è¡¨æŸ¥çœ‹è¯¦æƒ…ä¸åœ°å€)</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>èŠ‚ç‚¹åç§°</th>
                        <th>çŠ¶æ€</th>
                        <th>ä»Šæ—¥æ¶ˆè€— (10wé™é¢)</th>
                        <th>è´Ÿè½½ç‡</th>
                        <th>ä¼˜é€‰æ®µ</th>
                    </tr>
                </thead>
                <tbody id="node-list"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>æœ¬é¡¹ç›®ç”± OkEmby ç¤¾åŒºå…±å»º | æ•°æ®æ¯ 10 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡</p>
        </div>
    </footer>

    <div id="detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">èŠ‚ç‚¹è¯¦æƒ…</h2>
                <button onclick="closeModal()" class="btn-close">Ã—</button>
            </div>
            
            <div class="modal-body">
                <p style="color: #aaa; margin-bottom: 10px;">ğŸ”— èŠ‚ç‚¹åä»£åœ°å€ (è¯·å¡«å…¥ Emby å®¢æˆ·ç«¯)ï¼š</p>
                <div class="proxy-url-box">
                    <code id="modal-url">https://...</code>
                    <button class="btn-copy" onclick="copyModalUrl()">å¤åˆ¶åœ°å€</button>
                </div>

                <p style="color: #aaa; margin-bottom: 10px;">ğŸ“ˆ 24å°æ—¶æµé‡è¶‹åŠ¿ (æ¨¡æ‹Ÿæ•°æ®)ï¼š</p>
                <div id="chart-requests" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>

    <script>
        // å®šä¹‰å…¨å±€å˜é‡ï¼Œå­˜å‚¨ä»æ•°æ®åº“æ‹‰å–çš„æ‰€æœ‰èŠ‚ç‚¹
        let globalNodesData = [];
        let myChart = null;

        // é¡µé¢ä¸€åŠ è½½ï¼Œå°±å»åç«¯æ‹‰å–çœŸæ•°æ®
        document.addEventListener('DOMContentLoaded', fetchNodes);

        async function fetchNodes() {
            const statusText = document.getElementById('system-status');
            try {
                // 1. è¯·æ±‚åç«¯ API
                const response = await fetch('/api/nodes');
                const nodes = await response.json();
                
                // 2. å°†æ•°æ®å­˜å…¥å…¨å±€å˜é‡ï¼Œä¾›â€œæ¨èæŒ‰é’®â€ä½¿ç”¨
                globalNodesData = nodes;

                // 3. æ¸²æŸ“è¡¨æ ¼
                const tbody = document.getElementById('node-list');
                tbody.innerHTML = ''; 

                nodes.forEach(node => {
                    const usagePercent = (node.today_usage / 100000 * 100).toFixed(1);
                    const isCongested = node.today_usage > 80000;
                    
                    const tr = document.createElement('tr');
                    tr.onclick = () => openNodeDetail(node.owner_name, node.proxy_url, node.today_usage);
                    
                    tr.innerHTML = `
                        <td>${node.owner_name}</td>
                        <td><span class="badge ${isCongested ? 'red' : 'green'}">${isCongested ? 'æ‹¥å µ' : 'åœ¨çº¿'}</span></td>
                        <td>${node.today_usage.toLocaleString()} / 100,000</td>
                        <td>
                            <div class="progress-bar ${isCongested ? 'red' : ''}">
                                <div class="fill" style="width: ${usagePercent}%"></div>
                            </div>
                        </td>
                        <td>${node.ip_segment}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                statusText.innerText = `æ­£å¸¸è¿è¡Œä¸­ (å…±ç›‘æ§ ${nodes.length} ä¸ªèŠ‚ç‚¹)`;

            } catch (err) {
                console.error('åŠ è½½å¤±è´¥:', err);
                statusText.innerText = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“ç»‘å®š';
                statusText.style.color = '#ff6b6b';
            }
        }

        // æ‰“å¼€å¼¹çª—
        function openNodeDetail(name, url, usage) {
            const modal = document.getElementById('detail-modal');
            const title = document.getElementById('modal-title');
            const urlCode = document.getElementById('modal-url');

            modal.style.display = 'flex';
            title.innerText = name + ' çš„è¯¦ç»†ç›‘æ§';
            urlCode.innerText = url;

            if (myChart != null && myChart != "" && myChart != undefined) {
                myChart.dispose();
            }
            myChart = echarts.init(document.getElementById('chart-requests'));

            // æ³¨æ„ï¼šå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å†™å†å²æ•°æ®APIï¼Œå›¾è¡¨æš‚æ—¶è¿˜æ˜¯ç”¨å½“å‰ç”¨é‡æ¨¡æ‹Ÿä¸€ä¸‹
            // ç­‰åç»­å®Œå–„äº† backend å†å²è®°å½•åŠŸèƒ½ï¼Œè¿™é‡Œå†æ”¹
            const hours = ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', 'Now'];
            const data = [500, 1200, 3000, 4500, 6000, 7500, usage/10]; 

            const option = {
                tooltip: { trigger: 'axis' },
                grid: { top: '10%', left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: hours, axisLine: { lineStyle: { color: '#888' } } },
                yAxis: { type: 'value', splitLine: { lineStyle: { color: '#333' } }, axisLine: { lineStyle: { color: '#888' } } },
                series: [{
                    name: 'è¯·æ±‚æ•°',
                    type: 'line',
                    smooth: true,
                    itemStyle: { color: '#4caf50' },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(76, 175, 80, 0.5)'}, {offset: 1, color: 'rgba(76, 175, 80, 0)'}]) },
                    data: data
                }]
            };
            myChart.setOption(option);
            window.addEventListener('resize', function() { myChart.resize(); });
        }

        function closeModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }

        function copyModalUrl() {
            const url = document.getElementById('modal-url').innerText;
            navigator.clipboard.writeText(url).then(() => alert('èŠ‚ç‚¹åœ°å€å·²å¤åˆ¶ï¼'));
        }

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šçœŸæ­£çš„æ™ºèƒ½æ¨è ---
        function recommendBestNode() {
            if (globalNodesData.length === 0) {
                alert('æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨åå†è¯•...');
                return;
            }

            // 1. è¿‡æ»¤æ‰å·²ç»æ‹¥å µçš„èŠ‚ç‚¹ (ç”¨é‡ > 90000)
            const availableNodes = globalNodesData.filter(node => node.today_usage < 90000);

            if (availableNodes.length === 0) {
                alert('âš ï¸ è­¦å‘Šï¼šæ‰€æœ‰èŠ‚ç‚¹ç›®å‰éƒ½å¤„äºé«˜è´Ÿè½½çŠ¶æ€ï¼å»ºè®®ç¨åå†è¯•ã€‚');
                return;
            }

            // 2. åœ¨å¯ç”¨èŠ‚ç‚¹ä¸­ï¼Œæ‰¾åˆ°ç”¨é‡æœ€å°çš„é‚£ä¸ª (Sort æ’åº)
            availableNodes.sort((a, b) => a.today_usage - b.today_usage);
            const bestNode = availableNodes[0];

            // 3. æ‰“å¼€å®ƒçš„è¯¦æƒ…é¡µ
            openNodeDetail(bestNode.owner_name + ' (ä»Šæ—¥æœ€ä½³ğŸš€)', bestNode.proxy_url, bestNode.today_usage);
            
            // 4. ç»™ä¸ªæç¤º
            // alert(`ä¸ºæ‚¨æ¨èè´Ÿè½½æœ€ä½èŠ‚ç‚¹ï¼š${bestNode.owner_name}\nä»Šæ—¥ä»…æ¶ˆè€—ï¼š${bestNode.today_usage} æ¬¡è¯·æ±‚`);
        }

        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>